---
description: Cortex Search Service Creation Patterns and Best Practices
alwaysApply: false
---
# Cortex Search Service Creation Standards
## Search Service Creation

### Correct Syntax Format (CRITICAL)

**Service Creation Pattern:**
```sql
CREATE OR REPLACE CORTEX SEARCH SERVICE <database>.<schema>.<service_name>
    ON <content_column>
    ATTRIBUTES <id_column>, <title_column>, <attribute_columns>
    WAREHOUSE = <warehouse_name>
    TARGET_LAG = '<time_period>'
    AS 
    SELECT 
        <id_column>,
        <title_column>,
        <content_column>,
        <attribute_columns>
    FROM <corpus_table>
```

**Critical Requirements:**
- **ATTRIBUTES must match SELECT columns**: If SELECT has `TITLE`, ATTRIBUTES must include `TITLE`
- **ON content_column**: Specify the searchable content column
- **WAREHOUSE is mandatory**: Use dedicated warehouse or `CURRENT_WAREHOUSE()`
- **AS SELECT pattern**: Complete SELECT with proper column aliases
- **TARGET_LAG considerations**: Use '5 minutes'

## Validation and Testing

### Basic Service Validation
```sql
-- 1. Verify service was created
SHOW CORTEX SEARCH SERVICES IN <database>.<schema>;

-- 2. Check service details
DESCRIBE CORTEX SEARCH SERVICE {database}.{schema}.{service_name};
```

### Search Testing (MANDATORY)
Test search services systematically:

**Testing Strategy:**
1. **Basic Search**: Simple query to verify functionality
2. **Content Relevance**: Test with domain-specific queries
3. **Filter Testing**: Test attribute-based filtering (if applicable)
4. **Edge Cases**: Test with empty results, complex queries

**Testing Pattern:**
```sql
-- Basic functionality test
SELECT SNOWFLAKE.CORTEX.SEARCH_PREVIEW(
    '{service_name}',
    '{"query": "test query", "limit": 1}'
);

-- Domain-specific test
SELECT SNOWFLAKE.CORTEX.SEARCH_PREVIEW(
    '{service_name}',
    '{"query": "{relevant_business_term}", "limit": 3}'
);

```

### Validation Checklist
- [ ] Search service created without errors
- [ ] `SHOW CORTEX SEARCH SERVICES` lists the service
- [ ] Basic search returns results
- [ ] Domain-specific searches return relevant content
- [ ] Attribute filtering works (if applicable)
- [ ] No performance issues during search

## Adding New Search Services

### Integration Requirements (MANDATORY)
When adding a new search service, you must update **3 locations** in the code:

1. **Table Validation** - Add underlying table to `get_required_tables_for_search_services()`:
   ```python
   def get_required_tables_for_search_services(scenarios: List[str]) -> Set[str]:
       required_tables = set()
       # ... existing tables ...
       required_tables.add('YOUR_NEW_TABLE')  # Add this
       return required_tables
   ```

2. **Service Creation** - Add service creation call to `create_all_search_services()`:
   ```python
   def create_all_search_services(session: Session, scenarios: List[str] = None) -> None:
       # ... existing service creation calls ...
       create_your_new_search_service(session)  # Add this
   ```

3. **Service Validation** - Add service to expected list in `validate_search_services()`:
   ```python
   expected_services = [
       'existing_search_svc',
       'your_new_search_svc'  # Add this
   ]
   ```

### New Service Function Pattern
```python
def create_your_new_search_service(session: Session) -> None:
    """Create Cortex Search service for [description]."""
    logger.info("Creating your new search service...")
    
    # Validate required table exists
    validate_required_tables(session, ['YOUR_TABLE'])
    
    session.sql(f"""
        CREATE OR REPLACE CORTEX SEARCH SERVICE {config.SNOWFLAKE['database']}.{config.SNOWFLAKE['ai_schema']}.your_new_search_svc
            ON CONTENT_COLUMN
            ATTRIBUTES ID, TITLE, [other_attributes]
            WAREHOUSE = {config.SNOWFLAKE['search_warehouse']}
            TARGET_LAG = '5 minutes'
            AS 
            SELECT 
                ID,
                TITLE,
                CONTENT_COLUMN,
                [other_columns]
            FROM {config.SNOWFLAKE['database']}.RAW_DATA.YOUR_TABLE
    """).collect()
    
    logger.info("Your new search service created successfully")
```

### Validation Integration Checklist
- [ ] Table added to `get_required_tables_for_search_services()`
- [ ] Service creation function implemented
- [ ] Service creation called from `create_all_search_services()`
- [ ] Service name added to `validate_search_services()` expected list
- [ ] Underlying data generation implemented
- [ ] Service tested with `SEARCH_PREVIEW()`

## Troubleshooting

### Common Error Messages and Solutions

**"Missing option WAREHOUSE"**
- **Cause**: WAREHOUSE parameter not specified
- **Solution**: Add `WAREHOUSE = <warehouse_name>` to service definition

**"invalid identifier"**
- **Cause**: ATTRIBUTES don't match SELECT column aliases
- **Solution**: Ensure ATTRIBUTES exactly match SELECT column names/aliases

**"table not found"**
- **Cause**: Corpus table doesn't exist or not accessible
- **Solution**: Verify corpus table exists with `SELECT COUNT(*) FROM {corpus_table}`

**"syntax error"**
- **Cause**: Incorrect AS SELECT pattern or column mappings
- **Solution**: Verify AS SELECT syntax and column aliases
