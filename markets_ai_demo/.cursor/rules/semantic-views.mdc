---
description: Complete step-by-step guide for creating and testing SEMANTIC VIEWs for Cortex Analyst.
alwaysApply: false
---
# Semantic Views Development Patterns

## üî¥ CRITICAL SYNTAX RULE - READ THIS FIRST üî¥

### The #1 Rule That You Must Never Forget

```
SEMANTIC_NAME  AS  DATABASE_COLUMN
     ‚Üë         ‚Üë         ‚Üë
   What      Always   Actual column
   users      this     from table
   say      direction  (from DESCRIBE)
```

**Before writing ANY dimension or metric:**
1. Run `DESCRIBE TABLE` to get exact column names
2. Decide what semantic name users will say
3. Write: `TABLE.SemanticName AS ACTUAL_COLUMN_NAME`
4. NOT: `TABLE.ACTUAL_COLUMN_NAME AS SemanticName` ‚Üê THIS IS WRONG

### Common Mistakes to Avoid

‚ùå **WRONG** - Using non-existent column name:
```sql
-- If table has column SECTOR:
SECTORS.SECTOR AS SECTOR_NAME  -- Error! SECTOR_NAME doesn't exist
```

‚úÖ **CORRECT** - Semantic name matches or differs from actual column:
```sql
-- If table has column SECTOR:
SECTORS.SECTOR AS SECTOR              -- Users say "SECTOR", column is SECTOR
SECTORS.SECTOR_NAME AS SECTOR         -- Users say "SECTOR_NAME", column is SECTOR
SECTORS.COMPANY_SECTOR AS SECTOR      -- Users say "COMPANY_SECTOR", column is SECTOR
```

### Real Example from Our Project

**DIM_SECTOR table has these columns:**
```sql
CREATE TABLE CURATED.DIM_SECTOR (
    SECTOR VARCHAR(50) PRIMARY KEY,        -- Actual column
    SECTOR_DESCRIPTION VARCHAR(500)        -- Actual column
)
```

‚ùå **WRONG**:
```sql
SECTORS.SECTOR AS SECTOR_NAME  -- Tries to find column SECTOR_NAME, fails!
```

‚úÖ **CORRECT**:
```sql
SECTORS.SECTOR AS SECTOR WITH SYNONYMS=('sector_name','industry_sector')
-- Users can say "SECTOR" or "sector_name", actual column is SECTOR
```

## Schema Requirements for Semantic Views

**CRITICAL RULE**: Semantic views must ONLY reference tables from the **CURATED** schema.

### Why This Matters
- Semantic views are for **structured data analysis** with Cortex Analyst
- RAW schema contains unstructured documents (corpus tables)
- Unstructured documents should be accessed via **Cortex Search services**

### Schema Usage
‚úÖ **CORRECT** - Only CURATED tables:
```sql
CREATE OR REPLACE SEMANTIC VIEW AI.MY_VIEW
  TABLES (
    COMPANIES AS CURATED.DIM_COMPANY
    PRICES AS CURATED.FACT_STOCK_PRICE_DAILY
    CLIENTS AS CURATED.DIM_CLIENT
  )
```

‚ùå **WRONG** - Using RAW schema tables:
```sql
CREATE OR REPLACE SEMANTIC VIEW AI.MY_VIEW
  TABLES (
    COMPANIES AS CURATED.DIM_COMPANY
    REPORTS AS RAW.RESEARCH_REPORTS_CORPUS     -- ‚ùå NO RAW tables!
    NEWS AS RAW.NEWS_ARTICLES_CORPUS           -- ‚ùå NO RAW tables!
  )
```

### How to Access Unstructured Data
Use **Cortex Search services** (not semantic views):
- Create search service on `RAW.RESEARCH_REPORTS_CORPUS`
- Create search service on `RAW.NEWS_ARTICLES_CORPUS`
- Agents use both Cortex Analyst (semantic views) and Cortex Search (documents)

## CRITICAL: Semantic View Creation Rules
**MANDATORY**: Follow these exact patterns for all semantic view development

### Complete Syntax Pattern
```sql
CREATE OR REPLACE SEMANTIC VIEW <database>.<schema>.<view_name>
	TABLES (
		<table_alias> AS <physical_table_name>
			PRIMARY KEY (column1, column2) 
			WITH SYNONYMS=('synonym1','synonym2') 
			COMMENT='Table description'
	)
	RELATIONSHIPS (
		<relationship_name> AS <table_alias>(foreign_key_column) REFERENCES <table_alias>(primary_key_column)
	)
	DIMENSIONS (
		<table_alias>.<alias_name> AS <actual_column_name> WITH SYNONYMS=('synonym1','synonym2') COMMENT='Description'
	)
	METRICS (
		<table_alias>.<alias_name> AS <aggregation_function>(<actual_column_name>) WITH SYNONYMS=('synonym1','synonym2') COMMENT='Description'
	)
	COMMENT='View description';
```

### Section-by-Section Patterns

#### TABLES Section Pattern
```sql
TABLES (
	<table_alias> AS <database>.<schema>.<physical_table_name>
		PRIMARY KEY (column1, column2) 
		WITH SYNONYMS=('synonym1','synonym2') 
		COMMENT='Table description'
)
```

**Examples:**
```sql
-- ‚úÖ CORRECT
ACTUALS AS CURATED.FACT_EARNINGS_ACTUAL
	PRIMARY KEY (TICKER, FISCAL_QUARTER, METRIC_NAME)
	WITH SYNONYMS=('earnings_results','financial_results')
	COMMENT='Actual quarterly earnings results'

-- ‚ùå WRONG - reversed order
CURATED.FACT_EARNINGS_ACTUAL AS ACTUALS
```

#### RELATIONSHIPS Section Pattern
```sql
RELATIONSHIPS (
	<relationship_name> AS <table_alias>(foreign_key_column) REFERENCES <table_alias>(primary_key_column)
)
```

**Examples:**
```sql
-- ‚úÖ CORRECT
ACTUALS_TO_COMPANIES AS ACTUALS(TICKER) REFERENCES COMPANIES(TICKER)

-- ‚ùå WRONG - missing table aliases
ACTUALS(TICKER) REFERENCES COMPANIES(TICKER)
```

#### DIMENSIONS Section Pattern (CRITICAL)
```sql
DIMENSIONS (
	<table_alias>.<alias_name> AS <actual_column_name> WITH SYNONYMS=('synonym1','synonym2') COMMENT='Description'
)
```

**Key Rule**: `<actual_column_name>` MUST exist in the physical table

**Examples:**
```sql
-- ‚úÖ CORRECT - TICKER exists in CURATED.DIM_COMPANY table
COMPANIES.COMPANY_TICKER AS TICKER WITH SYNONYMS=('symbol','stock_ticker') COMMENT='Company ticker symbol'

-- ‚úÖ CORRECT - COMPANY_NAME exists in CURATED.DIM_COMPANY table  
COMPANIES.COMPANY_NAME AS COMPANY_NAME WITH SYNONYMS=('company','firm_name') COMMENT='Company name'

-- ‚ùå WRONG - COMPANY_TICKER does not exist as column in physical table
COMPANIES.TICKER AS COMPANY_TICKER WITH SYNONYMS=('symbol','stock_ticker')
```

#### METRICS Section Pattern (CRITICAL)
```sql
METRICS (
	<table_alias>.<alias_name> AS <aggregation_function>(<actual_column_name>) WITH SYNONYMS=('synonym1','synonym2') COMMENT='Description'
)
```

**Key Rule**: Must use aggregation functions (SUM, AVG, COUNT, MAX, MIN, etc.)

**Examples:**
```sql
-- ‚úÖ CORRECT - Uses aggregation function
ACTUALS.TOTAL_ACTUAL AS SUM(ACTUAL_VALUE) WITH SYNONYMS=('sum_actual','total_reported') COMMENT='Sum of actual values'

-- ‚úÖ CORRECT - Uses aggregation function
ESTIMATES.AVG_ESTIMATE AS AVG(ESTIMATE_VALUE) WITH SYNONYMS=('mean_consensus','average_forecast') COMMENT='Average estimate'

-- ‚ùå WRONG - No aggregation function
ACTUALS.ACTUAL_VALUE AS ACTUAL_VALUE WITH SYNONYMS=('reported_value')
```

### Critical Syntax Rules

#### ‚úÖ CORRECT Patterns
```sql
-- Table declaration
HOLDINGS AS SAM_DEMO.CURATED.FACT_POSITION_DAILY_ABOR

-- Relationship declaration  
HOLDINGS_TO_PORTFOLIOS AS HOLDINGS(PORTFOLIOID) REFERENCES PORTFOLIOS(PORTFOLIOID)

-- Dimension (alias_name AS actual_column_name)
PORTFOLIOS.PORTFOLIO_NAME AS PORTFOLIO_NAME WITH SYNONYMS=('fund_name','strategy_name')

-- Metric (alias_name AS aggregation_function)
HOLDINGS.TOTAL_MARKET_VALUE AS SUM(MARKET_VALUE) WITH SYNONYMS=('exposure','aum')
```

#### ‚ùå WRONG Patterns  
```sql
-- Wrong table order
SAM_DEMO.CURATED.FACT_POSITION_DAILY_ABOR AS HOLDINGS

-- Wrong dimension format (actual_column AS alias)
PORTFOLIOS.PORTFOLIO_NAME AS FUND_NAME

-- Wrong metric format (no aggregation)
HOLDINGS.MARKET_VALUE AS MARKET_VALUE

-- Duplicate expression names
ACTUALS.ACTUAL_VALUE AS SUM(ACTUAL_VALUE)
ACTUALS.TOTAL_VALUE AS SUM(ACTUAL_VALUE)  -- Same source column twice

-- Reserved word usage
HOLDINGS.SELECT AS SELECT_VALUE  -- SELECT is reserved

-- Duplicate synonyms across dimensions/metrics
SECURITIES: synonyms=('company_name')
ISSUERS: synonyms=('company_name')  -- Conflict!
```

### Formatting Requirements (MANDATORY)

- **Indentation**: Use tabs, not spaces
- **Synonyms**: Use `WITH SYNONYMS=('syn1','syn2')` format (equals sign, no spaces)
- **Comments**: Include meaningful comments for all elements
- **Case Sensitivity**: Use exact column names from `DESCRIBE TABLE <physical_table>`
- **No PUBLIC Keyword**: Never use PUBLIC in DIMENSIONS or METRICS sections
- **Unique Synonyms**: Each synonym can only appear once across all dimensions and metrics
- **Unique Expressions**: Each table.column can only appear once in METRICS section

### Column Name Verification Process

**MANDATORY**: Before creating semantic views, verify actual column names:

```python
# 1. Check table structure
session.sql("DESCRIBE TABLE CURATED.DIM_COMPANY").show()
session.sql("DESCRIBE TABLE CURATED.FACT_CONSENSUS_ESTIMATE").show()
session.sql("DESCRIBE TABLE CURATED.FACT_EARNINGS_ACTUAL").show()

# 2. Use exact column names in semantic view
# If DESCRIBE shows column 'TICKER', use:
COMPANIES.COMPANY_TICKER AS TICKER  # ‚úÖ CORRECT

# NOT:
COMPANIES.TICKER AS COMPANY_TICKER  # ‚ùå WRONG
```

### Error Handling Pattern

```python
def create_semantic_view(session: Session) -> None:
    semantic_view_sql = """..."""
    
    try:
        result = session.sql(semantic_view_sql).collect()
        print("‚úÖ Semantic view created successfully")
    except Exception as e:
        print(f"‚ùå Failed to create semantic view: {str(e)}")
        print(f"üìã Full SQL attempted:")
        print(semantic_view_sql)
        print("‚ùì Please help fix the SQL syntax error above")
        raise
```

### Common Errors and Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| `invalid identifier 'COLUMN_NAME'` | Column doesn't exist in physical table | Run `DESCRIBE TABLE` and use actual column name |
| `Duplicate expression name` | Same table.column used twice in METRICS | Use different source columns or combine logic |
| `You can only define aliases` | Snowpark parsing conflict | SQL syntax likely correct, issue with Snowpark |
| `Unexpected 'FACTS'` | FACTS section not supported | Use METRICS section instead |
| `syntax error` | Invalid section format | Check TABLES(), RELATIONSHIPS(), DIMENSIONS(), METRICS() |

### Complete Working Example

```sql
CREATE OR REPLACE SEMANTIC VIEW AI.EARNINGS_ANALYSIS_VIEW
	TABLES (
		ACTUALS AS CURATED.FACT_EARNINGS_ACTUAL
			PRIMARY KEY (TICKER, FISCAL_QUARTER, METRIC_NAME)
			WITH SYNONYMS=('earnings_results','financial_results')
			COMMENT='Actual quarterly earnings results',
		ESTIMATES AS CURATED.FACT_CONSENSUS_ESTIMATE  
			PRIMARY KEY (TICKER, FISCAL_QUARTER, METRIC_NAME, PROVIDER)
			WITH SYNONYMS=('consensus_estimates','analyst_estimates')
			COMMENT='Consensus estimates from data providers',
		COMPANIES AS CURATED.DIM_COMPANY
			PRIMARY KEY (TICKER)
			WITH SYNONYMS=('companies_master','company_info')
			COMMENT='Company master data'
	)
	RELATIONSHIPS (
		ACTUALS_TO_COMPANIES AS ACTUALS(TICKER) REFERENCES COMPANIES(TICKER),
		ESTIMATES_TO_COMPANIES AS ESTIMATES(TICKER) REFERENCES COMPANIES(TICKER)
	)
	DIMENSIONS (
		COMPANIES.COMPANY_TICKER AS TICKER WITH SYNONYMS=('symbol','stock_ticker') COMMENT='Company stock ticker',
		COMPANIES.COMPANY_NAME AS COMPANY_NAME WITH SYNONYMS=('company','firm_name') COMMENT='Company name',
		ACTUALS.FISCAL_QUARTER AS FISCAL_QUARTER WITH SYNONYMS=('period','quarter') COMMENT='Fiscal quarter',
		ACTUALS.METRIC_NAME AS METRIC_NAME WITH SYNONYMS=('financial_metric','kpi') COMMENT='Financial metric'
	)
	METRICS (
		ACTUALS.TOTAL_ACTUAL AS SUM(ACTUAL_VALUE) WITH SYNONYMS=('sum_actual','total_reported') COMMENT='Sum of actual results',
		ESTIMATES.AVG_ESTIMATE AS AVG(ESTIMATE_VALUE) WITH SYNONYMS=('mean_consensus','average_forecast') COMMENT='Average consensus estimate'
	)
	COMMENT='Earnings analysis semantic view for Cortex Analyst';
```

### Testing and Validation Patterns

#### Semantic View Testing Pattern (MANDATORY)
**CRITICAL**: Use these exact patterns for testing semantic views:

```sql
-- Basic functionality test
SELECT * FROM SEMANTIC_VIEW(
    {semantic_view_name}
    METRICS {primary_metric}
    DIMENSIONS {primary_dimension}
) LIMIT 5;

-- Complex query test
SELECT * FROM SEMANTIC_VIEW(
    {semantic_view_name}
    METRICS {metric1}, {metric2}
    DIMENSIONS {dimension1}, {dimension2}, {dimension3}
) LIMIT 10;

-- Business scenario test (use actual business queries your agents will run)
SELECT * FROM SEMANTIC_VIEW(
    {semantic_view_name}
    DIMENSIONS {relevant_dimensions}
    METRICS {relevant_metrics}
    WHERE {business_filters}
) LIMIT 20;
```

#### Testing Examples for Each View:

**EARNINGS_ANALYSIS_VIEW:**
```sql
-- Basic test
SELECT * FROM SEMANTIC_VIEW(
    AI.EARNINGS_ANALYSIS_VIEW
    METRICS TOTAL_ACTUAL
    DIMENSIONS TICKER
) LIMIT 5;

-- Complex test
SELECT * FROM SEMANTIC_VIEW(
    AI.EARNINGS_ANALYSIS_VIEW
    METRICS TOTAL_ACTUAL, AVG_ESTIMATE
    DIMENSIONS TICKER, FISCAL_QUARTER, METRIC_NAME
) LIMIT 10;
```

**THEMATIC_RESEARCH_VIEW:**
```sql
-- Basic test
SELECT * FROM SEMANTIC_VIEW(
    AI.THEMATIC_RESEARCH_VIEW
    METRICS AVG_PRICE
    DIMENSIONS TICKER
) LIMIT 5;
```

**CLIENT_MARKET_IMPACT_VIEW:**
```sql
-- Basic test
SELECT * FROM SEMANTIC_VIEW(
    AI.CLIENT_MARKET_IMPACT_VIEW
    METRICS ENGAGEMENT_COUNT
    DIMENSIONS CLIENT_NAME
) LIMIT 5;
```

### Development Workflow

1. **Plan the semantic view** - identify tables, relationships, dimensions, metrics
2. **Verify column names** - run `DESCRIBE TABLE` on each physical table
3. **Create the SQL** - follow exact syntax patterns above
4. **Test creation** - use error handling pattern to debug issues
5. **Validate functionality** - use SEMANTIC_VIEW() testing patterns above

## Pre-Creation Checklist

Before creating ANY semantic view, verify:

### ‚úÖ Schema Check
- [ ] All tables are from **CURATED** schema
- [ ] No RAW schema tables included
- [ ] No AI schema tables included (only for output, not input)

### ‚úÖ Syntax Check
- [ ] Ran `DESCRIBE TABLE` on all physical tables
- [ ] All dimensions use: `TABLE.SemanticName AS ACTUAL_COLUMN`
- [ ] All metrics use: `TABLE.MetricName AS AGGREGATION(ACTUAL_COLUMN)`
- [ ] Verified actual column names exist in tables

### ‚úÖ Relationship Check
- [ ] All relationships reference PRIMARY KEY columns only
- [ ] No relationships referencing non-key columns
- [ ] Relationship format: `NAME AS TABLE(FK) REFERENCES TABLE(PK)`

### ‚úÖ Common Errors to Avoid
- [ ] No backwards syntax: `TABLE.ACTUAL AS SEMANTIC` ‚úó
- [ ] No RAW schema tables ‚úó
- [ ] No non-existent column names ‚úó
- [ ] No relationships to non-primary-key columns ‚úó

**CRITICAL**: Semantic views are required for Cortex Analyst - regular SQL views will NOT work.