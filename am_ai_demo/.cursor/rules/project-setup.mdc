---
alwaysApply: true
---

# Snowcrest Asset Management (SAM) Demo - Project Setup Rules

Project structure, configuration management, and setup procedures for the SAM AI demo.

## Project Overview

**Company**: Snowcrest Asset Management (SAM)  
**Purpose**: Demonstrate Snowflake Intelligence capabilities for asset management customers  
**Architecture**: Multi-asset investment management firm with 10 portfolios across growth, value, ESG, and thematic strategies

## Project Structure

```
/
â”œâ”€â”€ .cursor/rules/              # Cursor AI development rules
â”‚   â”œâ”€â”€ agent-config.mdc       # Agent configuration guide
â”‚   â”œâ”€â”€ cortex-search.mdc      # Cortex Search creation guide
â”‚   â”œâ”€â”€ data-generation.mdc    # Enhanced data generation patterns
â”‚   â”œâ”€â”€ project-setup.mdc      # Project setup and configuration
â”‚   â”œâ”€â”€ semantic-views.mdc     # Semantic view creation guide
â”‚   â”œâ”€â”€ unstructured-data-generation.mdc # Document generation patterns
â”‚   â””â”€â”€ [other rules...]       # Additional development rules
â”œâ”€â”€ content_library/            # Pre-generated content templates (50+ templates)
â”‚   â”œâ”€â”€ _rules/                # Template configuration (placeholders, bounds, providers)
â”‚   â”œâ”€â”€ security/              # Security-level document templates
â”‚   â”œâ”€â”€ issuer/                # Issuer-level document templates
â”‚   â”œâ”€â”€ portfolio/             # Portfolio-level document templates
â”‚   â”œâ”€â”€ global/                # Global document templates
â”‚   â””â”€â”€ regulatory/            # Regulatory document templates
â”œâ”€â”€ docs/                      # Documentation
â”‚   â”œâ”€â”€ agents_setup.md       # Agent configuration instructions
â”‚   â”œâ”€â”€ data_model.md         # Data model documentation
â”‚   â”œâ”€â”€ demo_scenarios.md     # Demo conversation scripts
â”‚   â””â”€â”€ runbooks.md           # Operational procedures
â”œâ”€â”€ python/                    # Python implementation
â”‚   â”œâ”€â”€ config.py             # Configuration constants (CAPS naming)
â”‚   â”œâ”€â”€ main.py               # CLI orchestrator
â”‚   â”œâ”€â”€ generate_structured.py # Enhanced structured data generation (SecurityID model)
â”‚   â”œâ”€â”€ generate_unstructured.py # Template-based document generation
â”‚   â”œâ”€â”€ hydration_engine.py   # Template hydration engine
â”‚   â”œâ”€â”€ build_ai.py           # AI components (semantic views, search services)
â”‚   â””â”€â”€ extract_real_assets.py # Real asset data extraction and view creation
â”œâ”€â”€ research/                  # Research documents and analysis
â”‚   â””â”€â”€ [research files...]   # Industry research and model documentation
â”œâ”€â”€ .gitignore                # Git ignore patterns
â””â”€â”€ README.md                 # Quick setup guide
```

## Configuration Management

### Primary Configuration: `python/config.py`
All configuration uses structured objects following clean architecture principles:

```python
# Core settings
DEFAULT_CONNECTION_NAME = 'sfseeurope-mstellwall-aws-us-west3'
RNG_SEED = 42
YEARS_OF_HISTORY = 5

# Database configuration
DATABASE = {
    'name': 'SAM_DEMO',
    'schemas': {'raw': 'RAW', 'curated': 'CURATED', 'ai': 'AI'}
}

# Warehouse configuration  
WAREHOUSES = {
    'execution': {
        'name': 'SAM_DEMO_EXECUTION_WH',
        'size': 'MEDIUM'
    },
    'cortex_search': {
        'name': 'SAM_DEMO_CORTEX_WH',
        'size': 'MEDIUM',
        'target_lag': '5 minutes'
    }
}

# Data model configuration
DATA_MODEL = {
    'use_transaction_based': True,
    'generate_corporate_hierarchies': True,
    'issuer_hierarchy_depth': 2,
    'transaction_months': 12,
    'transaction_types': ['BUY', 'SELL', 'DIVIDEND', 'CORPORATE_ACTION'],
    'avg_monthly_transactions_per_security': 2.5,
    'portfolio_code_prefix': 'SAM'
}

# Securities configuration
SECURITIES = {
    'counts': {'equities': 10000, 'bonds': 3000, 'etfs': 1000},
    'real_assets_view': 'V_REAL_ASSETS',
    'sec_filings_database': 'SEC_FILINGS',
    'sec_filings_schema': 'CYBERSYN'
}

# Usage examples:
# config.DATABASE['name'] instead of config.DATABASE_NAME
# config.WAREHOUSES['execution']['name'] instead of config.EXECUTION_WAREHOUSE
# config.get_securities_count(test_mode=True) for dynamic calculations
```

### Connection Management
- Uses system default `~/.snowflake/connections.toml`
- Connection name configurable via CLI `--connection-name`
- Default connection: `sfseeurope-mstellwall-aws-us-west3`

### Warehouse Management
- **Execution Warehouse**: Accessed via `config.WAREHOUSES['execution']['name']`
- **Cortex Search Warehouse**: Accessed via `config.WAREHOUSES['cortex_search']['name']`
- **Size**: Configured in `config.WAREHOUSES[warehouse]['size']`
- **Auto-Management**: Both warehouses auto-suspend after 60 seconds, auto-resume when needed

## CLI Interface

### Main Command: `python/main.py`

**Core Parameters**:
- `--connection-name` (optional): Snowflake connection name
- `--scenarios` (optional): Comma-separated list of scenarios to build
- `--scope` (optional): `all|data|semantic|search` (default: `all`)
- `--extract-real-assets` (optional): Extract real asset data to CSV from SEC Filings dataset
- `--test-mode` (optional): Use 10% data volumes for faster development testing

**Examples**:
```bash
# Build everything with defaults
python main.py

# Build all scenarios (same as above)
python main.py --scenarios all

# Build specific scenarios
python main.py --scenarios portfolio_copilot,research_copilot

# Test mode: Build all scenarios with 10% data for faster development testing
python main.py --test-mode

# Optional: Extract real assets to CSV (requires SEC Filings access)
python main.py --extract-real-assets

# Build with synthetic market data (default behavior)
python main.py --scenarios portfolio_copilot

# Build only data layer
python main.py --scope data
```

### Test Mode for Development
**Purpose**: Faster builds during development and testing
**Usage**: `--test-mode` flag
**Data Reduction**: 10% of full data volumes (1,400 vs 14,000 securities, 205 vs 3,463 documents)
**Use Cases**: Code development, testing changes, validating functionality
**Performance**: Significantly faster build times while maintaining all functionality

## Database Architecture

**Database**: `SAM_DEMO`  
**Schemas**:
- `RAW`: External provider data simulation + raw unstructured documents
- `CURATED`: Industry-standard dimension/fact model ready for analysis
- `AI`: Semantic views and Cortex Search services

### Enhanced Data Model (Industry Standard)
```sql
-- Core Dimension Tables
DIM_ISSUER                    -- Corporate hierarchies and issuer relationships
DIM_SECURITY                  -- Immutable SecurityID with direct TICKER and FIGI columns
DIM_PORTFOLIO                 -- Enhanced portfolio information
DIM_BENCHMARK                 -- Benchmark reference data

-- Core Fact Tables
FACT_TRANSACTION              -- Canonical transaction log (source of truth)
FACT_POSITION_DAILY_ABOR      -- ABOR positions built from transactions
FACT_MARKETDATA_TIMESERIES    -- Enhanced market data with real data integration

-- Enhanced Document Integration
{DOCUMENT_TYPE}_CORPUS        -- Documents linked via SecurityID and IssuerID
```

### Enhanced Capabilities (100% Real Assets)
- **14,000+ Real Securities**: All from authentic OpenFIGI dataset (10K equities + 3K bonds + 1K ETFs)
- **Authentic Identifiers**: TICKER + real Bloomberg FIGI identifiers only
- **Immutable SecurityID**: Corporate action resilience and temporal integrity
- **Transaction Audit Trail**: Complete history for compliance and reconciliation
- **Issuer Hierarchies**: 3,303 real issuers with corporate structure relationships
- **Enhanced Document Integration**: Stable SecurityID/IssuerID linkage to real securities
- **Industry-Standard Architecture**: Professional asset management data model at scale

## Development Phases and Progress Tracking

### Current Implementation Status (Updated 2025-01-15)

#### âœ… **All 7 Agents: Automated SQL Creation Complete**
**Status**: All agents automatically created via `python/create_agents.py` using SQL `CREATE AGENT` statements
- âœ… **Automated Creation**: Agents created during `python main.py` build process
- âœ… **Proper Formatting**: All instructions use YAML escaping (`\n`, `\"`, `''`)
- âœ… **Full Instructions**: Portfolio Copilot, Research Copilot, Thematic Macro Advisor use complete docs
- âœ… **Comprehensive Instructions**: ESG Guardian, Compliance Advisor, Sales Advisor, Quant Analyst fully specified
- âœ… **Immediate Availability**: Agents appear in `SNOWFLAKE_INTELLIGENCE.AGENTS` after build

#### âœ… **Phase 1: Foundation Complete** (portfolio_copilot) - **100% Real Assets**
**Status**: Fully implemented and operational with 14,000+ real securities
- âœ… **100% Real Securities**: 14,000 authentic securities from OpenFIGI (10K equities + 3K bonds + 1K ETFs)
- âœ… **Authentic Identifiers**: All 14,000 securities have real Bloomberg FIGI identifiers
- âœ… **3,303 Real Issuers**: Corporate hierarchies and relationships from real companies
- âœ… Transaction-based holdings with major US stock prioritization (real tickers)
- âœ… 3 Cortex Search services (broker_research, earnings_transcripts, press_releases)
- âœ… 2 Semantic views (SAM_ANALYST_VIEW, SAM_RESEARCH_VIEW)
- âœ… ESG scores with sector/regional differentiation (scaled to 14K securities)
- âœ… Factor exposures with sector-specific characteristics
- âœ… Benchmark holdings with realistic index compositions
- âœ… Real market data integration (4M+ records with real/synthetic blend)
- âœ… Demo flow alignment (portfolio holdings match research coverage)

#### âœ… **Phase 2: Research & Analytics** (COMPLETED - Agents Created)
**Status**: `research_copilot`, `thematic_macro_advisor` - Automatically created via SQL
- âœ… **research_copilot**: Full instructions from docs, uses broker research, earnings, fundamentals data
- âœ… **thematic_macro_advisor**: Full instructions from docs, uses broker research, press releases

#### âœ… **Phase 3: Risk & Compliance** (COMPLETED - Agents Created)
**Status**: `esg_guardian`, `compliance_advisor` - Automatically created via SQL
- âœ… **esg_guardian**: Comprehensive instructions, ESG-focused with severity flagging
- âœ… **compliance_advisor**: Comprehensive instructions, mandate monitoring and breach detection
- ðŸ”„ **Document Enhancement** (Optional): Can add `ngo_reports`, `engagement_notes`, `policy_docs` for richer content

#### âœ… **Phase 4: Client & Quantitative** (COMPLETED - Agents Created)
**Status**: `sales_advisor`, `quant_analyst` - Automatically created via SQL
- âœ… **sales_advisor**: Comprehensive instructions, client-focused communication
- âœ… **quant_analyst**: Comprehensive instructions, factor analysis and attribution
- ðŸ”„ **Document Enhancement** (Optional): Can add `sales_templates`, `philosophy_docs` for richer content

### Available Scenarios by Implementation Status

```python
SCENARIO_STATUS = {
    # All agents now automatically created via SQL
    'portfolio_copilot': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO',
        'components': ['semantic_views', 'search_services', 'real_assets', 'transactions', 'esg', 'factors'],
        'agent_types': ['multi_tool_hybrid'],
        'last_tested': '2025-01-15'
    },
    
    'research_copilot': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO',
        'components': ['broker_research', 'earnings_transcripts', 'financial_analyzer'],
        'agent_types': ['search_focused', 'research_analyst'],
        'last_tested': '2025-01-15'
    },
    
    'thematic_macro_advisor': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO', 
        'components': ['broker_research', 'press_releases', 'quantitative_analyzer'],
        'agent_types': ['multi_search', 'thematic_analyst'],
        'last_tested': '2025-01-15'
    },
    
    'esg_guardian': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO',
        'components': ['quantitative_analyzer', 'esg_data'],
        'agent_types': ['compliance_focused', 'esg_analyst'],
        'enhancement_opportunities': ['ngo_reports', 'engagement_notes', 'policy_docs'],
        'last_tested': '2025-01-15'
    },
    
    'compliance_advisor': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO',
        'components': ['quantitative_analyzer', 'policy_search'],
        'agent_types': ['compliance_engine', 'rule_validator'],
        'last_tested': '2025-01-15'
    },
    
    'sales_advisor': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO',
        'components': ['quantitative_analyzer', 'broker_research'],
        'agent_types': ['client_focused', 'presentation_builder'],
        'enhancement_opportunities': ['sales_templates', 'philosophy_docs'],
        'last_tested': '2025-01-15'
    },
    
    'quant_analyst': {
        'status': 'IMPLEMENTED',
        'agent_created': 'SQL_AUTO',
        'components': ['quantitative_analyzer', 'factors', 'broker_research'],
        'agent_types': ['quantitative_analyst', 'model_explainer'],
        'last_tested': '2025-01-15'
    }
}
```

### Next Development Priorities

#### âœ… **All Agents Complete** - Focus on Enhancements

**Current State:**
- âœ… All 7 agents automatically created via SQL
- âœ… Full instructions for Portfolio Copilot, Research Copilot, Thematic Macro Advisor
- âœ… Comprehensive instructions for ESG Guardian, Compliance Advisor, Sales Advisor, Quant Analyst

**Optional Enhancements (Future Phases):**

1. **Document Enrichment** (Expand content coverage)
   - Add `ngo_reports` corpus for ESG Guardian controversy monitoring
   - Add `engagement_notes` corpus for corporate engagement tracking
   - Add `policy_docs` corpus for compliance policy search
   - Add `sales_templates` corpus for client presentation materials
   - Add `philosophy_docs` corpus for investment philosophy explanations

2. **Semantic View Enhancements** (Additional analytics)
   - Create `SAM_RISK_VIEW` for dedicated risk analysis
   - Create `SAM_PERFORMANCE_VIEW` for attribution analysis
   - Expand `SAM_ANALYST_VIEW` with additional risk metrics

3. **Demo Scenario Development** (Testing and refinement)
   - Test all 7 agents with realistic queries
   - Document successful query patterns
   - Create demo conversation scripts for each agent
   - Validate agent responses match expected behavior

## Prerequisites

### Required Setup
1. **Snowflake Account**: With Cortex features enabled and cross-region access
2. **Connection Configuration**: `~/.snowflake/connections.toml` properly configured
3. **Python Environment**: `snowflake-snowpark-python` installed

### Connection Configuration Template
```toml
[connections.sfseeurope-mstellwall-aws-us-west3]
account = "your-account"
user = "your-username"
password = "your-password"
warehouse = "your-warehouse"
database = "SAM_DEMO"
schema = "CURATED"
```

## Naming Standards and Reserved Keywords

### Reserved Keyword Compliance (VALIDATED)
Following [Snowflake reserved keywords](https://docs.snowflake.com/en/sql-reference/reserved-keywords):

**âœ… All Object Names Verified Safe:**
- **Table Names**: DIM_SECURITY, DIM_ISSUER, FACT_POSITION_DAILY_ABOR, FACT_TRANSACTION, etc.
- **Column Names**: SecurityID, IssuerID, PRIMARYTICKER, LEGALNAME, GICS_SECTOR, etc.
- **Warehouse Names**: SAM_DEMO_EXECUTION_WH, SAM_DEMO_CORTEX_WH
- **AI Objects**: SAM_ANALYST_VIEW, SAM_BROKER_RESEARCH, etc.

**Naming Conventions Used:**
- Underscore separation (PORTFOLIO_HOLDINGS not PORTFOLIO-HOLDINGS)
- Descriptive prefixes (SAM_DEMO_, SAM_)
- No reserved words as primary identifiers
- Consistent casing (UPPER_CASE for database objects)

### Reserved Keywords to Avoid
Critical keywords that cause issues:
- **Table/Column context**: TABLE, COLUMN, VIEW, SCHEMA, DATABASE
- **Query context**: SELECT, FROM, WHERE, ORDER, GROUP, SET
- **Expression context**: CASE, WHEN, TRUE, FALSE, NULL
- **Join context**: JOIN, LEFT, RIGHT, INNER, OUTER, CROSS

## Error Handling Standards

### Basic Error Management
- Try/catch blocks for all Snowflake operations
- Connection failure handling with clear error messages
- Missing data graceful handling (log warnings, continue processing)
- Validation checks before creating dependent objects

### Data Quality Checks
- Portfolio weights sum to 100% (Â±0.1% tolerance)
- Transaction log balances to position snapshots
- Security identifier integrity (direct TICKER and FIGI columns)
- Issuer hierarchy relationships valid
- No negative prices or market values
- Date ranges are consistent and logical
- All foreign key relationships exist

## Validation Standards

### Demo Readiness Checklist
- [ ] All enhanced foundation tables created successfully (DIM_SECURITY, FACT_TRANSACTION, etc.)
- [ ] Security identifier integrity validated (TICKER and FIGI columns populated)
- [ ] Transaction log balances to ABOR positions
- [ ] Issuer hierarchies established with corporate relationships
- [ ] Semantic view responds to test queries with issuer-level support
- [ ] Cortex Search services return relevant results with SecurityID/IssuerID attributes
- [ ] Enhanced data quality checks pass
- [ ] Performance acceptable for demo purposes

### Required Test Queries
```sql
-- Test enhanced semantic view with issuer support
DESCRIBE SEMANTIC VIEW SAM_DEMO.AI.SAM_ANALYST_VIEW;

-- Test basic portfolio analytics
SELECT * FROM SEMANTIC_VIEW(
    SAM_DEMO.AI.SAM_ANALYST_VIEW
    METRICS TOTAL_MARKET_VALUE, HOLDING_COUNT
    DIMENSIONS PORTFOLIONAME, DESCRIPTION
) LIMIT 5;

-- Test issuer-level analysis (enhanced capability)
SELECT * FROM SEMANTIC_VIEW(
    SAM_DEMO.AI.SAM_ANALYST_VIEW
    METRICS ISSUER_EXPOSURE
    DIMENSIONS LEGALNAME, GICS_SECTOR
) LIMIT 5;

-- Test enhanced search services with SecurityID attributes
SELECT SNOWFLAKE.CORTEX.SEARCH_PREVIEW(
    'SAM_DEMO.AI.SAM_BROKER_RESEARCH',
    '{"query": "technology investment", "limit": 2}'
);

-- Validate transaction-based model integrity
SELECT 
    COUNT(*) as transaction_count,
    COUNT(DISTINCT PortfolioID) as portfolios_with_transactions,
    COUNT(DISTINCT SecurityID) as securities_with_transactions
FROM SAM_DEMO.CURATED.FACT_TRANSACTION;
```

## Business Configuration Standards

### Benchmarks and Portfolio Rules
- **Benchmarks**: S&P 500, MSCI ACWI, Nasdaq 100
- **ESG Rules Apply To**: SAM ESG Leaders Global Equity; SAM Renewable & Climate Solutions
- **Compliance Rules**: 
  - Concentration: 7% cap, 6.5% warning threshold
  - Fixed Income: â‰¥75% Investment Grade, â‰¤5% CCC & below
  - ESG Floor: Minimum BBB rating for ESG-labelled portfolios

### Determinism and Analytics Standards
- **RNG Seed**: `RNG_SEED = 42` (configurable for consistent regeneration)
- **Base Currency**: USD for all analytics and reports
- **FX Hedging**: Fully hedged to USD for portfolios and benchmarks
- **Trading Calendar**: UTC with Mon-Fri business days
- **Returns Frequency**: Monthly for 5-year comparisons
- **Language**: UK English throughout generated content and agent responses

### Data Generation Defaults
- **Document Coverage**: Issuer-level for NGO/engagement, security-level for research
- **Identifier Management**: Deterministic hashing for stable IDs across runs
- **Overwrite Policy**: `CREATE OR REPLACE` for SQL objects, overwrite mode for DataFrames
- **Naming Standards**: Uppercase, unquoted identifiers compatible with Snowflake rules