---
alwaysApply: true
---

# SAM Demo - 100% Real Asset Implementation Rules

Complete implementation using authentic financial instrument data from SEC Filings dataset (OpenFIGI). **No synthetic securities generated** - all 14,000+ securities are real with authentic Bloomberg FIGI identifiers.

## Configuration

### Settings in `python/config.py`
```python
# Real asset data (always used via view - no configuration needed)
REAL_ASSETS_VIEW = 'V_REAL_ASSETS'  # View name in RAW schema
# Note: Real assets are automatically used via V_REAL_ASSETS view

# Data volumes (real assets only) - based on available capacity
SECURITIES_COUNT = {'equities': 10000, 'bonds': 3000, 'etfs': 1000}  # All real assets

# SEC Filings dataset configuration
# Dataset: "SEC Filings" - Financial statements, press releases, & fiscal calendars for US public companies
SEC_FILINGS_DATABASE = 'SEC_FILINGS'
SEC_FILINGS_SCHEMA = 'CYBERSYN'
```

## CLI Usage

### Real Assets View Creation
```bash
# Real assets are always loaded from a Snowflake view (no CSV required)
# The view is automatically created during the build process

# Build with 100% real assets (always the default and only mode)
python main.py --scenarios portfolio_copilot

# Test mode with smaller dataset for development
python main.py --test-mode --scenarios portfolio_copilot
```

## Implementation Pattern

### View-Based Implementation (Current Approach)
```python
# Real assets are used directly via SQL queries on the V_REAL_ASSETS view
from extract_real_assets import create_real_assets_view

# Ensure the view exists (automatically created during build)
create_real_assets_view(session)

# Use the view directly in SQL queries - no Pandas DataFrames needed
session.sql(f"""
    CREATE OR REPLACE TABLE {config.DATABASE_NAME}.CURATED.DIM_SECURITY AS
    WITH security_data AS (
        SELECT ra.PRIMARY_TICKER, ra.TOP_LEVEL_OPENFIGI_ID, ra.SECURITY_NAME
        FROM {config.DATABASE_NAME}.{config.SCHEMAS['RAW']}.V_REAL_ASSETS ra
        WHERE ra.PRIMARY_TICKER IS NOT NULL
    )
    SELECT * FROM security_data
""").collect()

print("✅ Using real asset data for securities (100% authentic mode)")
```

### Critical Implementation Rules

#### 1. **100% Real Assets Implementation**
- **NO SYNTHETIC SECURITIES**: All securities must come from real OpenFIGI dataset
- **Scale**: 14,000+ real securities (10K equities + 3K bonds + 1K ETFs)
- **Identifiers**: TICKER + authentic Bloomberg FIGI only
- **View-Based**: Real assets always loaded from V_REAL_ASSETS view
- **Auto-Creation**: View is created automatically during build process
- **Error on Database Access**: Hard error if SEC_FILINGS database not accessible

#### 2. **Handle Pandas NaN Values in String Operations**
```python
# ❌ WRONG - Will fail with 'float' object is not subscriptable
country = asset.get('COUNTRY_OF_DOMICILE', 'DE')[:2]

# ✅ CORRECT - Safe handling of NaN/float values  
country_of_domicile = asset.get('COUNTRY_OF_DOMICILE')
if country_of_domicile and not pd.isna(country_of_domicile) and isinstance(country_of_domicile, str):
    safe_country = country_of_domicile[:2]
else:
    safe_country = 'US'  # Default
```

#### 3. **Portfolio Holdings Alignment** 
- Ensure portfolio holdings prioritize major real stocks for demo coherence
- Use consistent prioritization in both `build_fact_transaction()` and `generate_unstructured.py`
- **Priority Order**: Major US stocks (AAPL, MSFT, NVDA, etc.) → Other real securities
- **Coverage**: All 14,000 real securities available for portfolio allocation

#### 4. **Demo Flow Coherence**
- Portfolio holdings must align with demo scenario questions
- Update demo scenarios to use actual portfolio holdings, not aspirational stocks
- Test actual holdings before updating demo documentation

### View-Based Query (No CSV Required)
The enhanced SQL query is now encapsulated in the `V_REAL_ASSETS` view:
```sql
-- View created in SAM_DEMO.RAW.V_REAL_ASSETS
-- Automatically created during build process
-- Key features: NO LIMIT clause, expanded asset categories, includes CIK
SELECT
    cs.MARKET_REGION,
    cs.ASSET_CATEGORY,
    cs.ISSUER_NAME,
    cs.INDUSTRY_SECTOR,
    cs.TOP_LEVEL_OPENFIGI_ID,
    cs.SECURITY_NAME,
    cs.PRIMARY_TICKER,
    cs.PRIMARY_EXCHANGE_CODE,
    cs.PRIMARY_EXCHANGE_NAME,
    cs.COUNTRY_OF_DOMICILE,
    cs.EXCHANGE_CODES,
    cs.CIK                    -- Included for SEC filings integration
FROM SAM_DEMO.RAW.V_REAL_ASSETS
-- View queries SEC_FILINGS.CYBERSYN tables directly
```

### View Creation Pattern
```python
# In extract_real_assets.py
def create_real_assets_view(session: Session):
    """Create view for real assets using OpenFIGI standard"""
    # Creates V_REAL_ASSETS view in RAW schema
    # Queries SEC_FILINGS.CYBERSYN tables directly
    # Includes expanded asset classes: Equity/Corp Bond/Govt Bond/Muni/ETF
    # Maps company relationships for issuer dimension
    # Includes CIK for SEC filings integration
```

## Data Source Requirements

### SEC Filings Dataset Prerequisites
- **Dataset**: "SEC Filings" - Financial statements, press releases, & fiscal calendars for US public companies
- **Database**: `SEC_FILINGS.CYBERSYN`
- **Tables**: 
  - `OPENFIGI_SECURITY_INDEX` (security master data)
  - `COMPANY_SECURITY_RELATIONSHIPS` (company linkages)
  - `COMPANY_INDEX` (includes CIK identifiers)
  - `COMPANY_CHARACTERISTICS` (company attributes)
- **Compute**: Sufficient warehouse for view queries

### Fallback Strategy (Current Working)
- Real major tickers: AAPL, MSFT, NVDA, ASML, TSM, NESTLE, etc.
- Proper geographic distribution: 55% US, 30% EU, 15% APAC/EM
- Correct asset classes: 70% Equity, 20% Bonds, 10% ETF
- Realistic characteristics: Bond ratings, ETF structures

## Tested Results

### Successful View Creation
- ✅ **Total Assets**: 90,000+ real securities available in view
- ✅ **Distribution**: USA, EU, APAC/EM across all regions
- ✅ **No Storage**: View queries live data - no CSV files needed
- ✅ **Geographic Coverage**: Authentic global market representation
- ✅ **CIK Integration**: Direct linkage to SEC filing data

### Benefits of Real Assets
- Authentic ticker symbols for enhanced demo credibility
- Proper industry sector classifications from SIC codes
- Real geographic distribution across global markets
- Enhanced customer presentation authenticity

## Real Asset Data Processing Optimization Patterns

### Implementation Strategy Overview
**Status**: ✅ **FULLY IMPLEMENTED** - All real asset functions use SQL-only approach

**Core Principles**:
1. **SQL-First**: All operations use native Snowflake SQL for maximum performance
2. **View-Based**: Single V_REAL_ASSETS view as source of truth
3. **No Data Movement**: No Pandas DataFrames or temporary tables
4. **Error Fast**: Hard error if SEC_FILINGS database not accessible

### Function Implementation Pattern

#### Current Pattern: Direct SQL on V_REAL_ASSETS View
**Use Case**: All real asset data processing (issuers, securities, etc.)
**Example**: `build_dim_issuer`, `build_dim_security`

```python
def build_real_asset_function(session: Session):
    """Pattern for direct SQL-based real asset processing"""
    
    # Ensure V_REAL_ASSETS view exists
    from extract_real_assets import create_real_assets_view
    create_real_assets_view(session)
    
    # Build dimension table using direct SQL query on the view
    session.sql(f"""
        CREATE OR REPLACE TABLE {config.DATABASE_NAME}.CURATED.TARGET_TABLE AS
        WITH processed_data AS (
            SELECT 
                COALESCE(ISSUER_NAME, SECURITY_NAME) as LegalName,
                COALESCE(COUNTRY_OF_DOMICILE, 'US') as CountryOfIncorporation,
                COALESCE(INDUSTRY_SECTOR, 'Diversified') as GICS_Sector,
                CIK
            FROM {config.DATABASE_NAME}.{config.SCHEMAS['RAW']}.V_REAL_ASSETS
            WHERE COALESCE(ISSUER_NAME, SECURITY_NAME) IS NOT NULL
                AND COALESCE(ISSUER_NAME, SECURITY_NAME) != 'Unknown'
        )
        SELECT 
            ROW_NUMBER() OVER (ORDER BY LegalName) as ID,
            LegalName,
            CountryOfIncorporation,
            GICS_Sector,
            CIK
        FROM processed_data
        ORDER BY LegalName
    """).collect()
    
    # Get count for reporting
    count = session.sql(f"SELECT COUNT(*) as cnt FROM {config.DATABASE_NAME}.CURATED.TARGET_TABLE").collect()[0]['CNT']
    print(f"✅ Created {count:,} records from real asset data")
```

#### Key Benefits of SQL-Only Approach
- **Performance**: No data movement between Python and Snowflake
- **Simplicity**: Direct SQL queries without Pandas complexity
- **Scalability**: Handles large datasets efficiently in Snowflake
- **Reliability**: No NaN handling issues or temporary table management

### Implementation Status (COMPLETED)

#### ✅ Current Functions (SQL-Based)
1. **`build_dim_issuer`** - Direct SQL queries on V_REAL_ASSETS view
2. **`build_dim_security`** - Direct SQL queries joining view with issuer table
3. **`create_real_assets_view`** - Creates view from SEC_FILINGS database
4. **`verify_sec_filings_access`** - Validates database access

#### ✅ Performance Results
- **View Creation**: 90,000+ real securities available in view
- **Issuer Generation**: All real issuers using direct SQL on view
- **Security Generation**: All real securities using direct SQL on view
- **Market Data**: 4M+ records with synthetic generation for all securities
- **No Pandas**: All operations use native Snowflake SQL for maximum performance

#### ✅ Demo Flow Alignment (RESOLVED)
- **Issue**: Portfolio holdings didn't align with research coverage
- **Solution**: Prioritized major US stocks (AAPL, MSFT, NVDA, etc.) in both:
  - Transaction generation (`build_fact_transaction`)
  - Document generation (`generate_unstructured.py`)
- **Result**: Coherent demo flow with aligned holdings and research

### Current Implementation Best Practices

#### 1. **Function Structure Template**
```python
def build_real_asset_function(session: Session):
    """Template for current SQL-based real asset functions"""
    
    # Step 1: Verify V_REAL_ASSETS view exists (created once during foundation build)
    from extract_real_assets import verify_real_assets_view_exists
    verify_real_assets_view_exists(session)
    
    # Step 2: Use direct SQL queries on the view
    session.sql(f"""
        CREATE OR REPLACE TABLE {config.DATABASE_NAME}.CURATED.TARGET_TABLE AS
        SELECT 
            -- Direct selection from view with transformations
            COALESCE(ISSUER_NAME, SECURITY_NAME) as ProcessedName,
            CIK,
            PRIMARY_TICKER,
            TOP_LEVEL_OPENFIGI_ID
        FROM {config.DATABASE_NAME}.{config.SCHEMAS['RAW']}.V_REAL_ASSETS
        WHERE PRIMARY_TICKER IS NOT NULL
    """).collect()
    
    # Step 3: Report results
    count = session.sql(f"SELECT COUNT(*) as cnt FROM {config.DATABASE_NAME}.CURATED.TARGET_TABLE").collect()[0]['CNT']
    print(f"✅ Created {count:,} records from real asset data")
```

#### 2. **Error Handling Requirements** 
- Hard error if SEC_FILINGS database not accessible during view creation
- Hard error if V_REAL_ASSETS view doesn't exist when functions try to use it
- View creation happens once during foundation build
- No fallback to synthetic data - real assets only
- Report actual counts from view queries

#### 3. **Performance Best Practices**
- **SQL-Only**: All operations use native Snowflake SQL
- **No Data Movement**: No Pandas DataFrames or temporary tables
- **View-Based**: Single source of truth via V_REAL_ASSETS view
- **Efficient Queries**: Use CTEs and proper WHERE clauses

## Market Data Generation (SYNTHETIC ONLY)

### Current Status
**Status**: ✅ Synthetic market data generation for all securities

**Configuration**:
```python
# Market data configuration (in config.py)
# All market data is generated synthetically for all securities
```

**Working Commands**:
```bash
# Build with synthetic market data for all securities (default mode)
python main.py --scenarios portfolio_copilot
```

### Implementation Results
- ✅ **Generation**: Synthetic OHLCV data for all 14,000+ securities
- ✅ **Consistency**: Uniform data quality across all securities  
- ✅ **Performance**: Excellent performance with synthetic-only approach
- ✅ **Simplicity**: No external data dependencies or hybrid logic
- ✅ **Benefits**: Realistic volatility patterns and consistent market behavior

## Implementation Status (100% REAL ASSETS COMPLETE)

### Phase 1: Real Asset Extraction ✅
**File**: `python/extract_real_assets.py`
- ✅ Complete OpenFIGI dataset extraction (92,573 securities)
- ✅ Comprehensive asset coverage: Equity, Corporate Bond, ETF, Government Bond, Municipal Bond
- ✅ Global coverage: USA, EU, APAC/EM regions
- ✅ Authentic Bloomberg FIGI identifiers for all securities

### Phase 2: 100% Real Implementation ✅
**File**: `python/generate_structured.py`
- ✅ **NO SYNTHETIC SECURITIES**: All 14,000+ securities from real data
- ✅ `build_dim_security_from_real_data()` - real-only mode with error on missing CSV
- ✅ Enhanced filtering: Asset-category-specific logic for quality
- ✅ **Scale**: 10,000 equities + 3,000 bonds + 1,000 ETFs
- ✅ Authentic identifiers: TICKER + real Bloomberg FIGI only

### Phase 3: Real-Only Configuration ✅
**File**: `python/config.py` 
- ✅ `SECURITIES_COUNT = {'equities': 10000, 'bonds': 3000, 'etfs': 1000}`
- ✅ `USE_REAL_ASSETS_CSV = True` (required - no synthetic fallback)
- ✅ Realistic targets based on available real data capacity

### Phase 4: Validation & Quality ✅
**Results**: 14,000 securities with 100% authentic Bloomberg identifiers
- ✅ **Authenticity**: All FIGI identifiers start with "BBG" (real Bloomberg codes)
- ✅ **Scale**: 28x increase from 500 to 14,000 securities
- ✅ **Coverage**: 3,303 real issuers across global markets
- ✅ **Integration**: 27,000+ portfolio holdings using real securities
- ✅ **AI Compatibility**: All semantic views and agents work unchanged

### Key Implementation Lessons

#### Data Source Challenges Solved
- **Issue**: Real assets CSV only contained APAC/EM and EU regions, no USA entries
- **Solution**: Modified extraction to use all equity regions, filter by ticker format
- **Learning**: Always validate data structure before implementing extraction logic

#### Query Optimization Required
- **Issue**: Initial query too restrictive (exchange filters, asset class, date range)
- **Solution**: Simplified query, reduced date range to 2 years, removed strict filters
- **Learning**: Start with broad queries and narrow down based on data availability

#### Integration Architecture
- **Pattern**: Use temporary tables for efficient real data processing
- **Approach**: `COALESCE()` function for seamless real/synthetic blending
- **Fallback**: Always provide synthetic alternative when real data unavailable
- **Statistics**: Report real vs synthetic data usage for transparency

### Working Commands (100% Real Mode)
```bash
# Build with 100% real assets (always the default and only mode)
python main.py --scenarios portfolio_copilot

# Test mode with smaller dataset (1,400 securities)
python main.py --test-mode --scenarios portfolio_copilot

# Full scale with all real assets (14,000+ securities)
python main.py --scenarios all

# Build specific scenarios
python main.py --scenarios research_copilot,thematic_macro_advisor
```

### Validated Results (100% Real Implementation)
- ✅ **Scale**: 14,000 real securities vs. 500 mixed securities previously
- ✅ **Authenticity**: 100% Bloomberg FIGI identifiers (all start with "BBG")  
- ✅ **Coverage**: 3,303 real issuers across Equity/Bond/ETF asset classes
- ✅ **Integration**: 27,000+ portfolio holdings using authentic securities
- ✅ **Performance**: Excellent performance with real-only approach
- ✅ **AI Compatibility**: All agents and demos work unchanged