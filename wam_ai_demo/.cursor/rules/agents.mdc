---
alwaysApply: true
---

# WAM AI Demo - Agent Configuration Rules

## Agent Creation Method

**✅ SQL-Based Agent Creation (Current Implementation)**
- All agents created automatically using `CREATE AGENT` SQL statements
- Executed via `src/create_agents.py` during build process
- Comprehensive tool descriptions following SAM demo best practices
- YAML instruction formatting with proper escaping for SQL embedding

**Agent Creation Commands:**
```bash
# Create all agents
python main.py --connection YOUR_CONNECTION --scope agents

# Full build with agents
python main.py --connection YOUR_CONNECTION --scope all

# Specific scenarios
python main.py --connection YOUR_CONNECTION --scope agents --scenarios advisor analyst
```

## Agent Naming Standards
- **Agent Names**: Use `wam_*_copilot` format (e.g., `wam_advisor_copilot`)
- **Display Names**: Use "* CoPilot (WAM Demo)" format (e.g., "Wealth Advisory CoPilot (WAM Demo)")
- **Current Agents** (All SQL-based):
  - `wam_advisor_copilot` - Display Name: "Wealth Advisory CoPilot (WAM Demo)"
  - `wam_analyst_copilot` - Display Name: "Portfolio Analysis CoPilot (WAM Demo)"  
  - `wam_compliance_copilot` - Display Name: "Compliance CoPilot (WAM Demo)"
  - `wam_advisor_manager_copilot` - Display Name: "Advisor Benchmarking CoPilot (WAM Demo)"

## SQL-Based Tool Configuration (Current Implementation)

**CRITICAL**: Tools configured in SQL `CREATE AGENT` statements with comprehensive descriptions following SAM best practices.

### Tool Description Pattern (SAM Section 2.2.1)
All tools must include these sections:

**Cortex Analyst Tools:**
```yaml
- tool_spec:
    type: "cortex_analyst_text_to_sql"
    name: "tool_name"
    description: |
      [One-sentence purpose statement]
      
      Data Coverage:
      - Historical: [time range]
      - Current: [update frequency]
      - Sources: [underlying tables]
      - Records: [approximate scale]
      - Refresh: [refresh schedule with timezone]
      
      Semantic Model Contents:
      - Tables: [table list with brief purpose]
      - Key Metrics: [primary metrics available]
      - Time Dimensions: [date columns and granularity]
      - Common Filters: [frequently used dimension filters]
      
      When to Use:
      - [Specific use case 1 with example query pattern]
      - [Specific use case 2 with example query pattern]
      - Questions like: "[example question 1]", "[example question 2]"
      
      When NOT to Use:
      - [Anti-pattern 1 with alternative: "Use {other_tool} instead"]
      - [Anti-pattern 2 with alternative: "Use {other_tool} instead"]
      
      Query Best Practices:
      1. Be specific about time ranges:
         ✅ "in the last 30 days" or "as of 2024-12-31"
         ❌ "recently" or "current" (ambiguous)
      
      2. Use semantic metric names:
         ✅ "total market value", "portfolio weight"
         ❌ Raw SQL column names (model handles this)
```

**Cortex Search Tools:**
```yaml
- tool_spec:
    type: "cortex_search"
    name: "search_tool_name"
    description: |
      [One-sentence purpose statement]
      
      Data Sources:
      - Document Types: [types of documents included]
      - Update Frequency: [how often new documents added]
      - Historical Range: [typical age range of documents]
      - Index Freshness: [lag between creation and searchability]
      - Typical Count: [approximate number of documents]
      
      When to Use:
      - [Specific use case 1 with example]
      - [Specific use case 2 with example]
      - Queries like: "[example question]"
      
      When NOT to Use:
      - [Anti-pattern 1 with alternative tool]
      - [Anti-pattern 2 with alternative tool]
      
      Search Query Best Practices:
      1. Use specific company/product names:
         ✅ "Microsoft Azure cloud computing strategy"
         ❌ "cloud strategy" (too generic)
      
      2. Include multiple related keywords:
         ✅ "artificial intelligence machine learning strategy investment"
         ❌ "AI" (too broad, returns too many results)
```

## SQL Agent Implementation Structure

### Agent Creation Function Pattern
```python
def create_agent_name(session: Session):
    """Create Agent Name with comprehensive tool descriptions"""
    database_name = config.DATABASE_NAME
    
    # Get instructions from helper functions
    instructions = get_agent_instructions()['agent_name']
    response_formatted = format_instructions_for_yaml(instructions['response'])
    orchestration_formatted = format_instructions_for_yaml(instructions['orchestration'])
    
    sql = f"""
CREATE OR REPLACE AGENT {database_name}.AI.wam_agent_name
  COMMENT = '[2-3 sentence description: persona + capabilities + value proposition]'
  PROFILE = '{{"display_name": "[Display Name] (WAM Demo)"}}'
  FROM SPECIFICATION
  $$
  models:
    orchestration: claude-sonnet-4-5
  instructions:
    response: "{response_formatted}"
    orchestration: "{orchestration_formatted}"
  tools:
    [Tool specifications with comprehensive descriptions]
  tool_resources:
    [Tool resource configurations]
  $$;
"""
    
    session.sql(sql).collect()
    print("✅ Created agent: wam_agent_name")
    
    # Register with Snowflake Intelligence
    try:
        session.sql(f"""
            ALTER SNOWFLAKE INTELLIGENCE SNOWFLAKE_INTELLIGENCE_OBJECT_DEFAULT 
            ADD AGENT {database_name}.AI.wam_agent_name
        """).collect()
        print("✅ Registered agent with Snowflake Intelligence")
    except Exception as e:
        print(f"⚠️ Agent registration note: {e}")
```

### Instruction Helper Functions Pattern
```python
def get_agent_name_response_instructions() -> str:
    """Get response instructions following SAM Section 3.2.1 pattern"""
    return """[Professional tone and formatting guidelines]"""

def get_agent_name_orchestration_instructions() -> str:
    """Get orchestration instructions with business context and workflows"""
    return f"""{get_wam_business_context()}

Tool Selection Strategy:
[Detailed tool selection logic]

{get_wam_error_handling_patterns()}"""
```

### YAML Formatting Helper
```python
def format_instructions_for_yaml(text: str) -> str:
    """Format multi-line instructions for YAML specification within SQL"""
    formatted = text.replace('\n', '\\n')
    formatted = formatted.replace('"', '\\"')
    formatted = formatted.replace("'", "''")
    return formatted
```

### DEMO_SCENARIOS.md Structure
```markdown
## Scenario X: [Scenario Name]
### Persona: [Role]
### Business Challenge: [Problem statement]

### Demo Storyline: *"[Opening narrative]"*

### Step-by-Step Demo Flow:
#### Step 1: [Action]
**Demo Operator Says**: *"[What to say]"*
**User Query**: `"[Exact query]"`
**Expected Agent Response**: [Response details]
**Demo Talking Points**: 
- *"[Business value point 1]"*

### Business Impact Summary:
- **[Metric]**: [Impact description]
```

## Response Instructions Guidelines
**Purpose**: Set rules for how the agent should sound and respond to users

- No promissory statements; cite sources; use "according to our records"
- Professional tone appropriate for each persona (wealth management, portfolio management, compliance)
- When discussing ESG/sustainability topics, reference specific metrics and commitments
- Highlight thematic investment opportunities where relevant
- Define communication style, formatting preferences, and behavioral boundaries
- Specify what the agent should/shouldn't do when responding

## Planning Instructions Guidelines  
**Purpose**: Define how the agent should think through complex queries by specifying planning strategies like breaking down tasks, exploring ambiguities, or routing across tools

- Classify queries by type: QUANTITATIVE (numbers, calculations), QUALITATIVE (summaries, context), THEMATIC (ESG, watchlists)
- For mixed questions: Use analyst tools first, then search tools with results as context
- Always synthesize multiple tool outputs into coherent response
- Include tool sequencing examples (Analyst → Search or vice versa)
- Define decision-making logic for tool selection and execution order
- Specify how to handle ambiguous or multi-part queries

## Available Data Sources
- **Semantic Views**: `CLIENT_FINANCIALS_SV`, `CLIENT_INTERACTIONS_SV`, `WATCHLIST_ANALYTICS_SV`, `ADVISOR_PERFORMANCE_SV`
- **Search Services**: `COMMUNICATIONS_SEARCH`, `RESEARCH_SEARCH`, `REGULATORY_SEARCH`, `PLANNING_SEARCH`, `DEPARTURE_SEARCH`
- **Custom Tools**: Available for specific use cases requiring custom functions

## Standard Test Queries by Agent Type

### Wealth Manager (advisor_copilot)
- Portfolio analytics + communication history
- Meeting preparation scenarios
- ESG and thematic investment queries

### Portfolio Manager (analyst_copilot)  
- Investment research + quantitative analysis
- Market commentary synthesis
- Thematic exposure analysis

### Compliance Officer (compliance_copilot)
- Communication surveillance
- Regulatory rule lookup
- Risk pattern identification

### Advisor Benchmarking (advisor_manager_copilot)
- TTM advisor performance analytics
- Peer quartile benchmarking
- Client retention and engagement analysis
- Planning coverage and risk signal monitoring

## Prerequisites

**CRITICAL**: Before creating agents, ensure:
1. **Snowflake Intelligence object exists**: Run `SHOW SNOWFLAKE INTELLIGENCES` to verify
   - If not found, create with: `CREATE SNOWFLAKE INTELLIGENCE <name>;`
   - Documentation: https://docs.snowflake.com/en/user-guide/snowflake-cortex/snowflake-intelligence
2. **Agent Schema**: Agents are created in `WAM_AI_DEMO.AI` schema (not SNOWFLAKE_INTELLIGENCE.AGENTS)
3. **Agent Registration**: After creation, agents are registered with Snowflake Intelligence using `ALTER SNOWFLAKE INTELLIGENCE`

## Adding New Agents

### Step-by-Step Process
1. **Create instruction functions** in `src/create_agents.py`:
   ```python
   def get_new_agent_response_instructions() -> str:
       """Response instructions with SAM best practices"""
   
   def get_new_agent_orchestration_instructions() -> str:
       """Orchestration with business context and workflows"""
   ```

2. **Add to instruction registry**:
   ```python
   def get_agent_instructions():
       return {
           # ... existing agents
           'new_agent': {
               'response': get_new_agent_response_instructions(),
               'orchestration': get_new_agent_orchestration_instructions()
           }
       }
   ```

3. **Create agent function** with comprehensive tool descriptions following SAM patterns

4. **Register in create_all_agents()**:
   ```python
   agents_to_create = {
       # ... existing agents
       'new_agent': create_new_agent
   }
   ```

5. **Test with build process**:
   ```bash
   python main.py --connection YOUR_CONNECTION --scope agents
   ```

### Validation Checklist
- [ ] Use **SAM Section 2.2.1** for comprehensive tool descriptions
- [ ] Include **Data Coverage**, **When to Use/NOT**, **Query Best Practices**
- [ ] Add **Business Context** and **Error Handling** to orchestration
- [ ] Follow **YAML escaping** patterns for SQL embedding
- [ ] Test agent creation and accessibility

@src/create_agents.py
@AGENT_SETUP_GUIDE.md
@DEMO_SCENARIOS.md