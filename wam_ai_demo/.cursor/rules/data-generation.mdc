---
alwaysApply: true
---

# WAM AI Demo - Data Generation Rules

## File Organization
- **SINGLE STRUCTURED FILE**: All structured data generation must be in `src/generate_structured.py`
- **SINGLE UNSTRUCTURED FILE**: All unstructured data generation must be in `src/generate_unstructured.py`
- **NO SEPARATE FILES**: Do not create separate files for ESG, watchlists, or themed data

## Core Data Model
- Enhanced model with immutable `SecurityID` and issuer hierarchy
- Volumes: 5 advisors × 25 clients (≈125 clients), 2 accounts/client, 12–18 holdings/account
- Region mix: 80% US, 20% EU securities
- Golden tickers: `AAPL, MSFT, NVDA, JPM, V, SAP`

## Golden Records System
Golden Records provide controlled data generation for demo consistency:

### Configuration Pattern (config.py)
```python
GOLDEN_CLIENTS = {
    "sarah_johnson": {
        "first_name": "Sarah", "last_name": "Johnson",
        "risk_tolerance": "Conservative", "investment_horizon": "Long-term",
        "advisor_id": 1, "portfolio_allocations": {"V": 0.25, "JPM": 0.25}
    }
}

GOLDEN_DOCUMENTS = {
    "planning": {"education_funding_plan": "src/golden_records/planning/sarah_johnson_education_funding_plan.md"}
}
```

### Handler Pattern (src/golden_records_handler.py)
- `is_golden_client_record(client_data: dict) -> bool`: Detection logic
- `apply_golden_client_overrides(client_data: dict) -> dict`: Apply controlled attributes
- `generate_golden_portfolio_positions()`: Control portfolio allocations
- `load_golden_document()` and `insert_golden_*_documents()`: Use pre-generated content

### Integration Points
- `src/generate_structured.py`: Apply golden client overrides and portfolio positions
- `src/generate_unstructured.py`: Insert golden planning and research documents
- `src/validate_components.py`: Validate golden records meet criteria

## Advisor Benchmarking System
Complete TTM performance analytics for leadership insights:

### Data Model Extensions (managed in src/setup.py)
- `DIM_MANAGER`: Regional manager hierarchy  
- `DIM_ADVISOR`: Enhanced with ManagerID
- `DIM_CLIENT`: Enhanced with departure tracking (EndDate, DepartureReason, DepartureNotes)
- `FACT_ADVISOR_CLIENT_RELATIONSHIP`: Advisor-client relationship history
- `ADVISOR_ROSTER`: Summary table for advisor details
- `ADVISOR_SUMMARY_TTM`: Pre-calculated TTM performance metrics
- `DEPARTURE_CORPUS`: Exit questionnaires and feedback

### Generation Pattern (src/generate_structured.py)
```python
# Advisor benchmarking data generation order:
generate_managers(session)
generate_advisors(session)
generate_clients(session)  # with golden record integration
# ... core data generation ...
generate_advisor_client_relationships(session)
generate_advisor_roster(session)
generate_advisor_summary_ttm(session)
```

## Critical Implementation Rules

### IDENTITY Column Handling
```python
# ✅ CORRECT: Use pandas + write_pandas for IDENTITY columns
import pandas as pd
df = pd.DataFrame(data_list)
session.write_pandas(df, table_name, overwrite=True, quote_identifiers=False)

# ❌ WRONG: Snowpark DataFrame save_as_table with IDENTITY
snowpark_df.write.mode("overwrite").save_as_table(table_name)  # Recreates table without IDENTITY
```

### SQL String Escaping
```python
# ✅ CORRECT: Escape single quotes
escaped_content = content.replace("'", "''")
session.sql(f"INSERT INTO table VALUES ('{escaped_content}')").collect()
```

### Real Data Integration
```python
# ✅ CORRECT: Graceful fallback
real_assets_df = load_real_assets_from_csv()
if not real_assets_df.empty:
    generate_from_real_assets(session, real_assets_df)
else:
    generate_synthetic_assets(session)
```

## Key Table Structure
- **DIM_SECURITY**: SecurityID IDENTITY(1,1) PRIMARY KEY, IssuerID FK
- **DIM_ISSUER**: IssuerID IDENTITY(1,1) PRIMARY KEY  
- **DIM_PORTFOLIO**: PortfolioID IDENTITY(1,1) PRIMARY KEY
- **FACT_POSITION_DAILY_ABOR**: Foreign keys to above dimensions

## Main.py Integration Rules

### **CRITICAL**: All Data Generation Must Be Triggered in Correct main.py Sections

**Structured Data Functions** must be called in the **Data Generation** section:
```python
# Data Generation Section (--scope 'all' or 'data')
if args.scope in ['all', 'data']:
    # Core structured data
    generate_managers(session)
    generate_advisors(session)
    generate_clients(session)  # includes golden record integration
    generate_issuers_and_securities(session)
    generate_portfolios_and_accounts(session)
    generate_simplified_positions(session)  # includes golden portfolio allocations
    generate_market_data(session)
    
    # ✅ ALWAYS CALL: Watchlists are part of structured data
    create_watchlists(session)
    
    # ✅ ALWAYS CALL: Advisor benchmarking data
    generate_advisor_client_relationships(session)
    generate_advisor_roster(session)
    generate_advisor_summary_ttm(session)
```

**Unstructured Data Functions** must be called in the **Data Generation** section:
```python
    # Core unstructured data
    generate_unstructured_data(session)
    
    # ✅ ALWAYS CALL: ESG content is part of unstructured data  
    create_esg_research_content(session)
```

### **NEVER Create Separate "Enhanced" or "Phase" Sections**
- ❌ Do NOT create conditional enhancement sections
- ❌ Do NOT use include_phase2 or similar parameters
- ✅ Integrate ALL data generation into the main flow
- ✅ New data functions MUST be added to the appropriate section

## Build Integrity
- Ensure owned holdings align with communications/research references
- Portfolio weights sum to 100% (±0.1% tolerance)
- All foreign key relationships valid

@src/generate_structured.py
@src/generate_unstructured.py
@main.py