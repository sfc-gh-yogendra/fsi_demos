---
alwaysApply: true
---

# WAM AI Demo - Real Data Integration Rules

## Overview

Real asset and market data integration using Snowflake Marketplace to enhance demo authenticity while providing fallback for accounts without marketplace access.

## Data Sources

### Marketplace Prerequisites
- **Dataset**: "Public Data Financials & Economics: Enterprise"
- **Database**: `FINANCIALS_ECONOMICS_ENTERPRISE.CYBERSYN`
- **Tables**: 
  - `OPENFIGI_SECURITY_INDEX` (security master data)
  - `COMPANY_SECURITY_RELATIONSHIPS` (company linkages)
  - `COMPANY_INDEX` (company information)
  - `COMPANY_CHARACTERISTICS` (company attributes)
  - `STOCK_PRICE_TIMESERIES` (real daily OHLCV data)

### CSV Fallback Strategy
- Extract data once to CSV files for accounts without marketplace access
- Hybrid approach: real data where available, synthetic fallback
- Deterministic selection ensuring golden tickers are included

## Configuration

### Real Data Settings
```python
# Real Asset Data Integration
USE_REAL_ASSETS_CSV = True
REAL_ASSETS_CSV_PATH = './data/real_assets.csv'
EXTRACT_REAL_ASSETS = False  # Set to True to extract from Marketplace

# Real Market Data Integration  
USE_REAL_MARKET_DATA = True
REAL_MARKET_DATA_CSV_PATH = './data/real_market_data.csv'
EXTRACT_REAL_MARKET_DATA = False  # Set to True to extract from Marketplace

# Marketplace Data Source (requires subscription)
MARKETPLACE_DATABASE = 'FINANCIALS_ECONOMICS_ENTERPRISE'
OPENFIGI_SCHEMA = 'CYBERSYN'
```

## Extraction Commands

### Extract Real Assets
```bash
# Extract real assets from Snowflake Marketplace
python main.py --extract-real-assets
```

**What this does**:
- Runs the comprehensive OpenFIGI query to extract securities
- Applies region classification (USA, EU, APAC/EM)
- Filters to reasonable dataset size (~3,000 securities)
- Ensures golden tickers are included
- Saves to `./data/real_assets.csv`

### Extract Real Market Data
```bash
# Extract real market data from Snowflake Marketplace  
python main.py --extract-real-market-data
```

**What this does**:
- Extracts OHLCV data for golden tickers + additional securities
- Covers last 2 years of trading data
- Filters to NASDAQ/NYSE securities with good data availability
- Saves to `./data/real_market_data.csv`

## Integration Workflow

### Recommended Workflow
```bash
# Step 1: Extract real data (if you have marketplace access)
python main.py --extract-real-assets
python main.py --extract-real-market-data

# Step 2: Build demo with real data integration
python main.py --mode replace_all

# Alternative: Test mode with real data
python main.py --mode replace_all --test-mode
```

### Fallback Workflow (No Marketplace Access)
```bash
# Build with synthetic data only
python main.py --mode replace_all

# The system will automatically detect missing CSV files and fall back to synthetic generation
```

## Data Quality and Benefits

### Real Assets Benefits
- ‚úÖ Authentic ticker symbols for enhanced credibility
- ‚úÖ Proper industry sector classifications
- ‚úÖ Real geographic distribution across global markets
- ‚úÖ Accurate asset class categorization
- ‚úÖ Corporate hierarchy information

### Real Market Data Benefits
- ‚úÖ Authentic OHLCV patterns and volatility
- ‚úÖ Realistic trading volumes and price movements
- ‚úÖ Historical correlation patterns between securities
- ‚úÖ Seasonal and market cycle effects
- ‚úÖ Enhanced demo authenticity for portfolio analysis

### Hybrid Approach
- **Real data**: Used for golden tickers and anchor portfolios
- **Synthetic data**: Generated for remaining securities to ensure complete coverage
- **Seamless integration**: `COALESCE()` function provides real data where available
- **Graceful fallback**: System works with or without marketplace access

## Error Handling

### Missing Marketplace Access
```
‚ùå Error: Marketplace data not accessible!
üí° You need access to 'Public Data Financials & Economics: Enterprise' dataset
   from Snowflake Marketplace
   Falling back to synthetic generation...
```

### Missing CSV Files
```
‚ùå Error: Real assets CSV file not found!
   Expected location: ./data/real_assets.csv
   To use real assets, you need:
   1. Access to 'Public Data Financials & Economics: Enterprise' dataset
   2. Run: python main.py --extract-real-assets
   3. Then run your normal build command
   Falling back to synthetic asset generation...
```

## Implementation Details

### Real Assets SQL Template
The extraction uses the exact SQL provided, with enhancements for:
- Proper asset class categorization
- Market region classification (USA, EU, APAC/EM)
- Industry sector mapping from SIC descriptions
- Filtering out non-standard security types

### Real Market Data SQL Template
The extraction uses the exact SQL provided, with enhancements for:
- Date range filtering (last 2 years)
- Quality filters (require close price)
- Exchange filtering (NASDAQ/NYSE focus)
- Volume and liquidity considerations

### Integration Architecture
```python
# Pattern: Use temporary tables for efficient real data processing
real_market_snowpark_df.write.mode("overwrite").save_as_table("TEMP_REAL_MARKET_DATA")

# Approach: COALESCE() function for seamless real/synthetic blending
COALESCE(real_data.CLOSE_PRICE, UNIFORM(50, 500, RANDOM())) as Price_Close

# Fallback: Always provide synthetic alternative when real data unavailable
if not real_assets_df.empty:
    generate_from_real_assets(session, real_assets_df)
else:
    generate_synthetic_assets(session)
```

## Validation and Reporting

### Data Source Transparency
The system reports:
- Number of real vs synthetic securities used
- Region and asset class distributions
- Market data coverage statistics
- Golden ticker inclusion verification

### Quality Checks
- ‚úÖ Golden tickers always included
- ‚úÖ Region mix maintained (80% US, 20% EU)
- ‚úÖ Asset class distribution preserved
- ‚úÖ Data integrity across real and synthetic components
- ‚úÖ Proper foreign key relationships maintained

## CLI Integration

### Command Line Options
```bash
# Extract real data
--extract-real-assets          # Extract assets to CSV
--extract-real-market-data     # Extract market data to CSV

# Build modes (work with or without real data)
--mode replace_all             # Full build
--mode data_only              # Data only
--mode semantics_and_search_only  # AI services only

# Testing
--test-mode                   # Reduced volumes
--validate-only               # Validation only
```

### Early Return Logic
Extraction commands return immediately after completion:
```python
if args.extract_real_assets:
    extract_real_assets_to_csv(session)
    return  # Exit after extraction

if args.extract_real_market_data:
    extract_real_market_data_to_csv(session)
    return  # Exit after extraction
```

## Best Practices

1. **Extract Once, Use Many**: Extract to CSV once, then use for multiple builds
2. **Test Mode First**: Use `--test-mode` to verify extraction works before full build
3. **Validate Extraction**: Check CSV files are created and contain expected data
4. **Monitor Usage**: Watch for marketplace quota limits during extraction
5. **Graceful Degradation**: System works reliably with or without real data

## Implementation Results (Validated)

### Successful Extraction Statistics
- ‚úÖ **Real Assets**: 2,539 securities extracted successfully
  - USA: 2,004 securities (80% target achieved)
  - EU: 225 securities (20% target achieved)  
  - Asset Classes: 2,148 Equities + 391 ETFs
  - Golden tickers: All 6 confirmed present (AAPL, MSFT, NVDA, JPM, V, SAP)

- ‚úÖ **Real Market Data**: 22,974 OHLCV records extracted successfully
  - Date range: 2023-09-11 to 2025-09-05 (nearly 2 years)
  - Unique tickers: 51 securities with complete data
  - Golden ticker coverage: 498 trading days each
  - Authentic price patterns: AAPL $179‚Üí$239, NVDA $450‚Üí$166

### Data Quality Validation (Tested)
```python
# ‚úÖ PROVEN: Data type safety for real assets
for _, asset in real_assets_df.iterrows():
    if pd.notna(asset['ISSUER_NAME']) and issuer_name not in issuer_map:
        issuers_data.append({
            'LegalName': str(asset['ISSUER_NAME']),  # Ensure string type
            'CountryOfIncorporation': str(asset['COUNTRY_OF_DOMICILE']) if pd.notna(asset['COUNTRY_OF_DOMICILE']) else 'US',
            'GICS_Sector': str(asset['INDUSTRY_SECTOR']) if pd.notna(asset['INDUSTRY_SECTOR']) else 'Other'
        })
```

### Error Handling Patterns (Working)
```python
# ‚úÖ PROVEN: Marketplace access validation
try:
    session.sql(f"SELECT 1 FROM {MARKETPLACE_DATABASE}.{OPENFIGI_SCHEMA}.OPENFIGI_SECURITY_INDEX LIMIT 1").collect()
    print("‚úÖ Marketplace data accessible")
except Exception as e:
    print("‚ùå Error: Marketplace data not accessible!")
    print("üí° You need access to 'Public Data Financials & Economics: Enterprise' dataset")
    return False
```

## File Locations

```
data/
‚îú‚îÄ‚îÄ real_assets.csv          # Extracted real asset data
‚îî‚îÄ‚îÄ real_market_data.csv     # Extracted real market data

src/
‚îî‚îÄ‚îÄ extract_real_data.py     # Extraction implementation
```

## Future Enhancements

- **Incremental Updates**: Extract only new/changed data
- **Data Quality Scoring**: Rate real vs synthetic data coverage
- **Regional Expansion**: Support APAC market data extraction
- **Corporate Actions**: Handle splits, dividends, mergers in real data
- **ESG Data Integration**: Extract ESG scores and sustainability metrics